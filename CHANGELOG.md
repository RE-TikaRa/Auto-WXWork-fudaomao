# 更新日志

## v1.8.3

- 调整备用定时触发策略：每个时间点仅在到点后 60 秒窗口内触发
- 调整启动策略：脚本启动当天自动跳过已过的备用时间点，避免“启动即补触发”
- 同步完善文档：更新触发机制、FAQ、维护规范与注释说明

## v1.8.2

- 修复自动模式潜在锁死：去除流程内阻塞弹窗，避免 `isRunning` 长时间占用
- 修复并发竞态：签到锁改为原子状态（`AtomicBoolean`），防止通知与定时同时进入
- 修复备用触发策略：当日“无活动”或“已全部签到”也标记为完成，避免无意义重复触发
- 增强通知监听容错：`events.observeNotification()` 启动失败时降级为仅备用定时并提示
- 增加配置告警：`fallbackTimes` 全无效时启动即输出告警

## v1.8.1

- 修复日志目录创建方式，按 AutoJs6 `files.ensureDir(path)` 语义确保持久化日志稳定写入
- 统一脚本代码格式（`main.js`、`tools/manual-checkin.js`、`tools/analyze-screen.js`）
- 文档同步更新（配置说明、项目结构与运行说明）

## v1.8.0

- 新增多备用定时：支持 `fallbackTimes`（如 `10:30, 12:00, 18:00`），每个时间点最多重试 3 次
- 新增签到结果系统通知：签到流程结束后推送通知，不依赖弹窗
- 新增日志持久化：签到结果自动写入 `logs/checkin-YYYY-MM-DD.log`

## v1.7.0

- 通知保活增强：每 30 秒自动刷新前台通知，防止用户手动删除后保活失效
- 备用定时重试：失败后最多重试 3 次（每 30 秒一次），不再一次失败就放弃

## v1.6.0

- 合并"已过期"和"错过签到"为统一的 `missed` 状态
- 简化结果弹窗：成功/已签到/错过签到/失败

## v1.5.0

- 优化活动名称显示：分离活动名称和截止时间，不再截断
- 结果弹窗显示完整活动名和截止时间（格式：活动名 (截止:2/21 22:00)）

## v1.4.1

- 启动时自动关闭上次运行遗留的弹窗（仅限本脚本的 alert 弹窗），避免遮挡导致启动失败

## v1.4.0

- 新增"错过签到"状态：识别已过期但未签到的活动（显示"未签到"但无签到按钮）
- 结果弹窗区分"已过期"和"错过签到"两种状态

## v1.3.1

- 在更多失败场景添加 debugPage 调用：企业微信启动失败、未找到辅导猫入口、没有今日活动

## v1.3.0

- 签到失败时自动调用 debugPage 分析当前页面，输出关键词检测和可点击控件信息

## v1.2.0

- 已过期活动也会进入详情页检查是否已签到（不再直接跳过）
- 结果弹窗显示失败/过期的具体活动名称

## v1.1.1

- 修复错误的过期判断逻辑："为何不能签到？"是页面固定链接，不能作为过期依据
- 过期检测现在仅依赖"已结束"印章和截止时间解析

## v1.1.0

- 在活动列表页根据截止时间过滤已过期活动，避免进入详情页后才发现过期
- 解析活动文本中的截止时间（格式：签到截止时间：2026年02月21日 22:00）
- 预扫描时标记已过期活动

## v1.0.16

- 修复页面加载过程中误判为过期的问题（将过期检测移到 waitFor 超时后）
- 只在轮询中查找签到按钮，超时后再检查过期状态

## v1.0.15

- 修复页面加载过程中误判为过期的问题
- 调整检测优先级：签到按钮 > 已签到 > 已过期（先找按钮再判断状态）

## v1.0.14

- 重构活动遍历逻辑：预扫描生成待签到列表，按名称去重避免重复处理
- 移除 while 循环，改用 for 循环遍历预生成的列表
- 每次处理前重新查找活动元素，适应页面刷新

## v1.0.13

- 修复 WebView 容器被误识别为签到按钮的问题
- 优化底部签到按钮检测（80% < Y < 95%），排除底部导航栏（Y > 95%）

## v1.0.12

- 修复已结束活动误点击底部导航栏"签到"tab 的问题
- 添加"已结束"印章检测，自动跳过已过期活动
- 优化"范围外签到"按钮识别，排除底部导航栏区域

## v1.0.11

- 修复签到时间过期检测时机问题（改为点击签到按钮后检测）
- 添加详细调试日志功能（debugPage）

## v1.0.10

- 修复强行停止后启动不回首页问题（用 home() 替代 back()）
- 启动后自动点击底部"消息"tab 确保回到消息页
- 移除 manual-checkin.js 中重复的启动代码

## v1.0.9

- 添加无障碍服务检测（运行前验证服务可用）
- 添加辅导猫页面加载失败重试机制（最多 2 次）

## v1.0.8

- 检测签到时间过期的活动并自动跳过（使用"已结束"印章检测）
- 结果弹窗新增"已过期"计数

## v1.0.7

- 修复通知触发时 UI 线程阻塞问题（使用子线程执行签到）

## v1.0.6

- 签到完成后弹窗显示结果（成功/已签到/失败数量）
- 添加 toast 短提示

## v1.0.5

- 修复前台通知在部分环境下无法创建的问题
- 简化通知代码，提高兼容性

## v1.0.4

- 添加前台服务通知机制，防止系统杀死后台脚本
- 为所有脚本添加完整详细注释（签到流程、算法说明、配置文档）
- tools/manual-checkin.js：添加签到状态机、拍照流程、遍历策略等注释
- tools/analyze-screen.js：添加控件类型说明、WebView 元素分析、快门识别等注释

## v1.0.3

- 修复活动遍历索引错位问题（改用 while 循环）
- 修复备用定时重复触发问题（添加 fallbackTriggered 标记）
- 修复 todayTriggered 设置时机（只在成功后设置）
- 修复变量名遮蔽问题（text 改名 notificationText）
- 添加唤醒失败检查
- 添加相机权限弹窗自动处理
- 快门按钮使用相对尺寸识别（10%-20% 屏幕宽度）
- 添加 app 启动检测结果检查
- 添加 activity.text() 空值保护

## v1.0.2

- 初始版本
- 通知触发 + 备用定时
- 批量活动处理
- 范围外签到支持
