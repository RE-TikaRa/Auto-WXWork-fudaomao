// ============================================================================
// 手动签到脚本
// ============================================================================
//
// 【脚本说明】
// 这是一个一次性执行的手动签到脚本，用于立即执行签到操作。
// 运行后会自动完成所有今日活动的签到，然后退出。
//
// 【与 main.js 的区别】
// - main.js: 常驻服务，监听通知自动触发，有备用定时
// - 本脚本: 一次性执行，立即签到，执行完毕后退出
//
// 【使用场景】
// 1. 测试签到流程是否正常工作
// 2. 错过自动签到时间后手动补签
// 3. 调试和验证签到逻辑
//
// 【运行方式】
// 在 AutoJs6 中直接运行此脚本即可
// ============================================================================

"auto";
auto.waitFor();

// ============================================================================
// 配置
// ============================================================================
//
// 【配置说明】
// 手动签到只需要基本配置，不需要通知触发和备用定时相关的配置。
// ============================================================================

var CONFIG = {
    // 企业微信包名
    packageName: "com.tencent.wework",
    // 范围外签到时填写的原因
    reasonText: "离校",
    // 辅导猫入口文本
    entryText: "辅导猫"
};

// ============================================================================
// 运行时常量
// ============================================================================

// 轮询间隔（毫秒）- 等待元素时的检查频率
var POLL_INTERVAL = 200;

// 单次等待超时（毫秒）- 等待单个元素的最长时间
var MAX_WAIT = 10000;

// 动画延迟（毫秒）- 点击前等待动画完成
var ANIM_DELAY = 500;

// 全局超时（毫秒）- 整个流程的最长执行时间（3分钟）
var GLOBAL_TIMEOUT = 180000;

// 全局开始时间 - 用于计算全局超时
var globalStart = Date.now();

// ============================================================================
// 工具函数
// ============================================================================

/**
 * 唤醒屏幕并解锁
 * @returns {boolean} 成功返回 true，失败返回 false
 */
function wakeUp() {
    if (device.isScreenOn()) return true;
    console.log(">>> 唤醒屏幕...");
    device.wakeUp();
    sleep(500);
    if (!device.isScreenOn()) {
        console.log(">>> 唤醒失败");
        return false;
    }
    console.log(">>> 上滑...");
    swipe(device.width / 2, device.height * 0.8, device.width / 2, device.height * 0.3, 300);
    sleep(500);
    return true;
}

/**
 * 等待某个条件满足（轮询模式）
 * @param {Function} finder - 查找函数
 * @param {number} [timeout=MAX_WAIT] - 超时时间
 * @returns {*} finder 返回的结果，超时返回 null
 */
function waitFor(finder, timeout) {
    timeout = timeout || MAX_WAIT;
    var start = Date.now();
    while (Date.now() - start < timeout) {
        // 检查全局超时
        if (Date.now() - globalStart > GLOBAL_TIMEOUT) {
            console.error(">>> 全局超时");
            return null;
        }
        var result = finder();
        if (result) return result;
        sleep(POLL_INTERVAL);
    }
    return null;
}

/**
 * 智能点击控件（三级回退策略）
 * @param {UiObject} widget - 要点击的控件
 * @returns {boolean} 点击是否成功
 */
function smartClick(widget) {
    if (!widget) return false;
    if (widget.clickable()) return widget.click();
    var p = widget.parent();
    if (p && p.clickable()) return p.click();
    var b = widget.bounds();
    return click(b.centerX(), b.centerY());
}

// ============================================================================
// 签到核心逻辑
// ============================================================================
//
// 【签到流程状态机】
// 进入活动详情页后，可能遇到以下状态：
//
//   ┌─────────────────────────────────────────────────────────────────────┐
//   │                        活动详情页                                    │
//   ├─────────────────────────────────────────────────────────────────────┤
//   │                                                                     │
//   │  状态1: 已签到                                                       │
//   │  └─ 页面显示"已签到"文本 → 直接返回，无需操作                         │
//   │                                                                     │
//   │  状态2: 范围外签到                                                   │
//   │  └─ 显示"范围外签到"按钮 → 点击后进入拍照流程                         │
//   │                                                                     │
//   │  状态3: 正常签到                                                     │
//   │  └─ 显示"签到"按钮 → 点击后可能直接成功或进入拍照流程                  │
//   │                                                                     │
//   └─────────────────────────────────────────────────────────────────────┘
//
// 【拍照流程】
//   点击签到 → [继续签到弹窗] → 去拍照 → [权限弹窗] → 拍照 → 使用照片
//            → [填写原因] → 完成签到
//
// 【按钮识别策略】
// 页面上可能有多个"签到"文本（如底部导航栏），需要通过坐标过滤：
// - Y 坐标 > 300px：排除顶部状态栏区域
// - Y 坐标 < 屏幕高度 * 0.7：排除底部导航栏区域
// - 优先匹配"范围外签到"（更精确）
// ============================================================================

/**
 * 执行单个活动的签到操作
 * 
 * 【函数职责】
 * 在活动详情页内完成签到操作，处理各种可能的页面状态和弹窗。
 * 
 * 【返回值说明】
 * - "already_signed": 活动已签到，无需操作
 * - "no_button": 未找到签到按钮（可能页面加载失败）
 * - "success": 签到成功
 * - "unknown": 签到结果不确定（未检测到成功标志）
 * - "error": 签到过程中发生异常（由调用方 catch）
 * 
 * @returns {string} 签到结果状态码
 */
function doCheckin() {
    // ========================================================================
    // 第一步：检测页面状态，查找签到按钮
    // ========================================================================
    // 使用 waitFor 轮询检测，因为页面可能还在加载中。
    // 检测优先级：已签到 > 范围外签到 > 普通签到
    // ========================================================================
    var pageState = waitFor(function() {
        // 优先检查是否已签到（最快路径）
        if (textContains("已签到").exists()) return "already_signed";
        
        // 其次查找"范围外签到"按钮（更精确的匹配）
        var btn = text("范围外签到").findOnce();
        if (btn) return { btn: btn };
        
        // 最后查找普通"签到"按钮
        // 注意：页面上可能有多个"签到"文本，需要通过坐标过滤
        var candidates = text("签到").find();
        for (var i = 0; i < candidates.length; i++) {
            var b = candidates[i].bounds();
            // 坐标过滤逻辑：
            // - centerY > 300: 排除顶部区域（状态栏、标题栏）
            // - centerY < height * 0.7: 排除底部区域（导航栏、TabBar）
            // 这样可以精确定位到页面中央的签到按钮
            if (b.centerY() < device.height * 0.7 && b.centerY() > 300) {
                return { btn: candidates[i] };
            }
        }
        return null;  // 继续轮询
    }, MAX_WAIT);
    
    // ========================================================================
    // 第二步：处理检测结果
    // ========================================================================
    
    // 情况1：已签到 - 直接返回，无需任何操作
    if (pageState === "already_signed") {
        console.log(">>> 已签到，跳过");
        return "already_signed";
    }
    
    // 情况2：未找到按钮 - 可能页面加载失败或结构变化
    if (!pageState || !pageState.btn) {
        console.log(">>> 未找到签到按钮");
        return "no_button";
    }
    
    // ========================================================================
    // 第三步：点击签到按钮
    // ========================================================================
    // 等待动画完成后再点击，避免点击到错误位置
    // ========================================================================
    sleep(ANIM_DELAY);
    console.log(">>> 点击: " + pageState.btn.text());
    smartClick(pageState.btn);
    
    // ========================================================================
    // 第四步：处理"继续签到"弹窗（可选）
    // ========================================================================
    // 某些情况下点击签到后会弹出确认框，需要再次点击"继续签到"
    // 使用较短超时（5秒），因为这个弹窗不一定出现
    // ========================================================================
    var continueBtn = waitFor(function() { return text("继续签到").findOnce(); }, 5000);
    if (continueBtn) {
        sleep(ANIM_DELAY);
        console.log(">>> 点击: 继续签到");
        smartClick(continueBtn);
    }
    
    // ========================================================================
    // 第五步：拍照流程（范围外签到的核心流程）
    // ========================================================================
    // 范围外签到需要拍照证明，流程如下：
    // 1. 点击"去拍照"按钮
    // 2. 处理相机权限弹窗（首次使用时）
    // 3. 点击快门按钮拍照
    // 4. 点击"使用照片"确认
    // 5. 填写签到原因（如"离校"）
    // 6. 点击"完成签到"
    // ========================================================================
    var photoBtn = waitFor(function() { return text("去拍照").findOnce(); }, 5000);
    if (photoBtn) {
        sleep(ANIM_DELAY);
        console.log(">>> 点击: 去拍照");
        smartClick(photoBtn);
        
        // --------------------------------------------------------------------
        // 5.1 处理相机权限弹窗
        // --------------------------------------------------------------------
        // 首次使用相机时，系统会弹出权限请求
        // 不同 Android 版本/厂商的按钮文本可能不同：
        // - "允许"：标准 Android
        // - "始终允许"：部分厂商 ROM
        // - "仅在使用中允许"：Android 10+ 的新选项
        // 使用较短超时（2秒），因为权限弹窗只在首次出现
        // --------------------------------------------------------------------
        var permissionBtn = waitFor(function() {
            return text("允许").findOnce() || text("始终允许").findOnce() || textContains("仅在使用").findOnce();
        }, 2000);
        if (permissionBtn) {
            console.log(">>> 处理权限弹窗");
            smartClick(permissionBtn);
            sleep(500);  // 等待权限弹窗关闭
        }
        
        // --------------------------------------------------------------------
        // 5.2 点击快门按钮
        // --------------------------------------------------------------------
        // 快门按钮识别策略（基于相对尺寸，适配不同分辨率）：
        // - 类型：ImageView（图片控件）
        // - 宽度：屏幕宽度的 10%-20%（典型快门按钮大小）
        // - 位置：水平居中（距离屏幕中心 < 50px）
        // 
        // 【为什么使用相对尺寸】
        // 不同手机分辨率差异很大（720p ~ 4K），使用绝对像素值会导致
        // 在某些设备上无法识别。相对尺寸（屏幕宽度的百分比）更通用。
        // --------------------------------------------------------------------
        var shutterBtn = waitFor(function() {
            var minSize = device.width * 0.1;   // 最小宽度：屏幕宽度的 10%
            var maxSize = device.width * 0.2;   // 最大宽度：屏幕宽度的 20%
            return className("android.widget.ImageView").filter(function(w) {
                var b = w.bounds();
                // 三个条件同时满足：
                // 1. 宽度在合理范围内
                // 2. 宽度在合理范围内（上限）
                // 3. 水平位置接近屏幕中心
                return b.width() >= minSize && b.width() <= maxSize && Math.abs(b.centerX() - device.width / 2) < 50;
            }).findOnce();
        }, 5000);
        if (shutterBtn) {
            sleep(ANIM_DELAY);
            var b = shutterBtn.bounds();
            console.log(">>> 点击快门: (" + b.centerX() + ", " + b.centerY() + ")");
            // 使用坐标点击而非 widget.click()，因为快门按钮可能不可点击
            click(b.centerX(), b.centerY());
        }
        
        // --------------------------------------------------------------------
        // 5.3 确认使用照片
        // --------------------------------------------------------------------
        // 拍照后会显示预览，需要点击"使用照片"确认
        // --------------------------------------------------------------------
        var usePhotoBtn = waitFor(function() { return text("使用照片").findOnce(); }, 5000);
        if (usePhotoBtn) {
            sleep(ANIM_DELAY);
            console.log(">>> 点击: 使用照片");
            smartClick(usePhotoBtn);
        }
        
        // --------------------------------------------------------------------
        // 5.4 填写签到原因
        // --------------------------------------------------------------------
        // 范围外签到需要填写原因说明
        // 流程：点击输入框 → 输入文本 → 收起键盘
        // 
        // 【重要】必须先收起键盘再点击提交按钮
        // 否则键盘可能遮挡"完成签到"按钮，导致点击失败
        // --------------------------------------------------------------------
        var inputBox = waitFor(function() { return className("EditText").findOnce(); }, 5000);
        if (inputBox) {
            sleep(ANIM_DELAY);
            console.log(">>> 填写: " + CONFIG.reasonText);
            smartClick(inputBox);  // 聚焦输入框
            sleep(300);            // 等待键盘弹出
            inputBox.setText(CONFIG.reasonText);  // 设置文本
            sleep(300);            // 等待文本输入完成
            back();                // 收起键盘（关键步骤！）
        }
        
        // --------------------------------------------------------------------
        // 5.5 点击"完成签到"按钮
        // --------------------------------------------------------------------
        // 使用 textContains 而非 text，因为按钮文本可能包含空格
        // 例如：" 完成签到" 或 "完成签到 "
        // 使用坐标点击确保可靠性
        // --------------------------------------------------------------------
        var finalBtn = waitFor(function() { return textContains("完成签到").findOnce(); }, 3000);
        if (finalBtn) {
            sleep(ANIM_DELAY);
            var b = finalBtn.bounds();
            console.log(">>> 点击完成签到: (" + b.centerX() + ", " + b.centerY() + ")");
            click(b.centerX(), b.centerY());
        }
    }
    
    // ========================================================================
    // 第六步：验证签到结果
    // ========================================================================
    // 检查页面是否显示"已签到"文本，作为签到成功的标志
    // 使用较短超时（5秒），因为签到结果应该很快显示
    // ========================================================================
    if (waitFor(function() { return textContains("已签到").exists() ? true : null; }, 5000)) {
        console.log(">>> 签到成功！");
        return "success";
    }
    
    // 未检测到成功标志，返回 unknown（可能成功也可能失败）
    return "unknown";
}

// ============================================================================
// 主流程
// ============================================================================
//
// 【执行步骤概览】
// 1. 唤醒屏幕并解锁
// 2. 杀掉企业微信后台（确保干净启动）
// 3. 启动企业微信
// 4. 进入辅导猫页面
// 5. 查找今日活动
// 6. 遍历每个活动执行签到
// 7. 输出结果汇总
//
// 【为什么要杀掉后台】
// 企业微信可能停留在某个子页面，直接启动可能无法进入工作台。
// 杀掉后台后重新启动，可以确保从主页面开始，流程更可控。
//
// 【活动遍历策略】
// 使用 while 循环每次处理第一个活动，而非 for 循环遍历索引。
// 原因：签到成功后活动可能从列表中消失或位置变化，
// 使用索引遍历会导致跳过活动或数组越界。
// ============================================================================

console.log("===== 手动签到 =====");

// ============================================================================
// 步骤 1：唤醒屏幕
// ============================================================================
// 如果屏幕关闭，需要先唤醒并解锁
// 唤醒失败（如设备不支持）则无法继续
// ============================================================================
if (!wakeUp()) {
    console.error(">>> 唤醒失败，退出");
    exit();
}

// ============================================================================
// 步骤 2：杀掉企业微信后台
// ============================================================================
// 通过系统设置页面的"强行停止"按钮杀掉应用
// 不同 ROM 的按钮文本可能是"强行停止"或"结束运行"
// ============================================================================
console.log(">>> 杀掉企业微信后台...");
app.openAppSetting(CONFIG.packageName);  // 打开企业微信的应用信息页面
var forceStopBtn = waitFor(function() {
    return text("强行停止").findOnce() || text("结束运行").findOnce();
}, 3000);
if (forceStopBtn && forceStopBtn.clickable()) {
    forceStopBtn.click();
    sleep(300);
    // 点击确认对话框
    var confirmBtn = waitFor(function() { return text("确定").findOnce(); }, 2000);
    if (confirmBtn) confirmBtn.click();
}
back();  // 返回上一页
sleep(300);

// ============================================================================
// 步骤 3：启动企业微信
// ============================================================================
// 启动后等待主界面加载完成
// 检测标志：辅导猫入口或"工作台"文本出现
// 超时时间较长（15秒），因为冷启动可能较慢
// ============================================================================
console.log(">>> 启动企业微信...");
app.launch(CONFIG.packageName);
sleep(3000);  // 等待应用初始化
var appLaunched = waitFor(function() { 
    return textContains(CONFIG.entryText).exists() || textContains("工作台").exists(); 
}, 15000);
if (!appLaunched) {
    console.error(">>> 企业微信启动超时，退出");
    exit();
}

// ============================================================================
// 步骤 4：进入辅导猫
// ============================================================================
// 在企业微信工作台中查找并点击辅导猫入口
// ============================================================================
var fudaomao = waitFor(function() { return textContains(CONFIG.entryText).findOnce(); }, 10000);
if (!fudaomao) {
    console.error(">>> 未找到辅导猫入口，退出");
    exit();
}
console.log(">>> 点击: 辅导猫");
smartClick(fudaomao);

// ============================================================================
// 步骤 5：查找今日活动
// ============================================================================
// 通过日期文本（如"02月21日"）匹配今日活动
// 日期格式：MM月DD日（带前导零）
// ============================================================================
var today = new Date();
var todayStr = (today.getMonth() + 1).toString().padStart(2, '0') + "月" + 
               today.getDate().toString().padStart(2, '0') + "日";
console.log(">>> 今天: " + todayStr);

sleep(2000);  // 等待辅导猫页面加载
var activities = textContains(todayStr).find();
console.log(">>> 找到 " + activities.length + " 个今日活动");

if (activities.length === 0) {
    console.log(">>> 没有今日活动，退出");
    exit();
}

// ============================================================================
// 步骤 6：遍历活动执行签到
// ============================================================================
// 【遍历策略】
// 使用 while 循环，每次处理列表中的第一个活动。
// 
// 【为什么不用 for 循环】
// 签到成功后，活动可能：
// - 从列表中消失（已完成的活动不再显示）
// - 位置发生变化（列表重新排序）
// 使用索引遍历会导致：
// - 跳过某些活动（索引 i 对应的活动已变化）
// - 数组越界（活动数量减少）
// 
// 【while 循环的优势】
// 每次都处理第一个活动，处理完后刷新列表。
// 无论列表如何变化，都能正确处理所有活动。
// ============================================================================
var results = [];        // 存储每个活动的签到结果
var processedCount = 0;  // 已处理的活动计数

while (activities.length > 0) {
    // 检查全局超时
    if (Date.now() - globalStart > GLOBAL_TIMEOUT) {
        console.error(">>> 全局超时，退出");
        break;
    }
    
    // 总是处理第一个活动，避免索引错位
    var activity = activities[0];
    var activityName = (activity.text() || "").substring(0, 25);  // 截取前25字符作为名称
    processedCount++;
    console.log("\n===== 活动 " + processedCount + ": " + activityName + " =====");
    
    // 点击进入活动详情页
    smartClick(activity);
    
    // 执行签到
    var result;
    try {
        result = doCheckin();
    } catch (e) {
        console.error("签到异常: " + e);
        result = "error";
    }
    results.push({ name: activityName, result: result });
    
    // 返回活动列表
    console.log(">>> 返回");
    back();
    sleep(1000);
    
    // 刷新活动列表
    // 签到后列表可能变化，需要重新查找
    activities = textContains(todayStr).find();
    
    // 处理活动列表丢失的情况
    // 可能原因：页面跳转异常、WebView 重新加载等
    if (activities.length === 0) {
        console.log(">>> 活动列表丢失，尝试重新进入辅导猫");
        back();  // 再返回一层
        sleep(1000);
        var fudaomao2 = waitFor(function() { return textContains(CONFIG.entryText).findOnce(); }, 5000);
        if (fudaomao2) {
            smartClick(fudaomao2);
            sleep(2000);
            activities = textContains(todayStr).find();
        }
    }
}

// ============================================================================
// 步骤 7：输出结果汇总
// ============================================================================
// 列出每个活动的签到结果，便于用户确认
// ============================================================================
console.log("\n===== 结果汇总 =====");
var successCount = 0;
var failCount = 0;
var skipCount = 0;
results.forEach(function(r, idx) {
    console.log((idx + 1) + ". " + r.name + " -> " + r.result);
    if (r.result === "success") successCount++;
    else if (r.result === "already_signed") skipCount++;
    else failCount++;
});
console.log("=== 完成 ===");

// 弹窗显示结果
var summary = "成功: " + successCount + "\n已签到: " + skipCount + "\n失败: " + failCount;
if (failCount === 0) {
    toast("签到完成！");
    alert("签到完成", summary);
} else {
    toast("签到有异常，请检查");
    alert("签到结果", summary + "\n\n请检查失败的活动");
}
