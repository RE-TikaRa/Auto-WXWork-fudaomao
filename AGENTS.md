# Repository Guidelines

## 项目结构与模块组织
本仓库是基于 AutoJs6 的企业微信辅导猫自动签到脚本，核心代码集中在少量脚本文件中：

- `main.js`：常驻服务入口，负责通知触发、备用定时、每日标记重置。
- `tools/manual-checkin.js`：手动执行一次完整签到流程，便于快速验证。
- `tools/analyze-screen.js`：界面分析工具，用于输出控件文本、坐标、可点击状态。
- `project.json`：AutoJs6 项目元信息（主入口、版本号、启动配置）。
- `README.md`：用户文档与配置说明。
- `AutoJs6-Documentation/`：本地 API 参考文档，不参与业务逻辑。

## 技术栈与运行环境
- 运行环境：AutoJs6（Rhino JS 引擎）。
- 目标系统：Android 7.0+（API 24+）。
- 开发语言：JavaScript（ES5 兼容）。
- 配置方式：各脚本顶部 `CONFIG` 自包含，不依赖外部配置文件。

## 构建、测试与开发命令
本项目无 Node/Python 构建流程，主要通过 AutoJs6 运行：

- 在 AutoJs6 中运行 `main.js`：启动自动签到服务。
- 在 AutoJs6 中运行 `tools/manual-checkin.js`：执行单次签到。
- 在 AutoJs6 中运行 `tools/analyze-screen.js`：分析当前页面控件。
- 打包当前代码快照（可选）：`git archive -o auto-workwx-v1.0.3.zip HEAD`。

## 代码风格与命名规范
- 保持 Rhino 兼容 ES5 语法（使用 `var`、`function`，避免现代语法）。
- 使用 4 空格缩进，流程代码保持短小、直接、可追踪。
- 命名约定：函数/变量使用 `camelCase`，常量使用 `UPPER_SNAKE_CASE`。
- UI 选择器必须贴合实际中文界面文案（如 `textContains("签到")`）。
- 遵循“最小必要改动”：重构时删除旧逻辑，不保留冗余兼容分支。

## 核心流程与实现约定
- 触发机制：通知触发（时间窗 + 关键词）与备用定时（未签到时执行）并存，日期变化时重置标记。
- 页面等待：优先轮询（默认 200ms）+ 动画缓冲（500ms），避免纯固定延迟。
- 点击策略：`widget.click()` → 父元素点击 → 坐标点击三级回退。
- 活动遍历：用 `while` 每次处理第一个活动，避免签到后列表变化导致索引错位。
- 跨设备适配：优先相对尺寸和坐标区间过滤，避免硬编码像素。

## 测试指南
- 当前未配置自动化测试框架，必须在真实 Android 设备上手测。
- 合并前至少验证：通知触发、备用定时仅触发一次、已签到活动跳过、拍照与权限弹窗流程可完成。
- 选择器不稳定时，先用 `tools/analyze-screen.js` 获取控件信息后再改代码。

## 重要约束与风险点
- 全局超时保护为 3 分钟，新增流程不得绕开超时控制。
- 远程运行（如 Shizuku）避免依赖 `waitForPackage/currentPackage`，优先用 UI 元素判断页面状态。
- 文本匹配优先 `textContains`（例如 `" 完成签到"` 可能含前导空格）。
- 首次拍照场景必须处理权限弹窗（允许/始终允许/仅使用中允许）。
- 不自动写入 Git 历史（禁止自动 commit/push）。

## 常见问题速记（维护必看）
- 备用定时重复触发：需要独立标记（如 `fallbackTriggered`）防重。
- 成功标记时机：仅在签到成功后设置，失败不能阻断备用定时。
- 变量名遮蔽：避免使用 `text` 等与 AutoJs 选择器同名变量。
- 键盘遮挡按钮：填写后先 `back()` 收起键盘再点击提交。
- 活动列表空白：应尝试返回并重新进入辅导猫页面。

## 提交与 PR 规范
- 提交信息遵循 Conventional Commits：`feat:`, `fix:`, `docs:`, `refactor(scope):`。
- 每次提交只做一类改动，避免混合功能与文档修改。
- PR 需包含：变更目的、影响文件、测试设备与系统版本、关键日志或截图（涉及 UI 流程时必需）。
