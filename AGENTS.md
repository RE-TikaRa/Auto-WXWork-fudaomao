# Repository Guidelines

## 项目结构与模块组织

本仓库是 AutoJs6（Rhino ES5）脚本项目，核心文件很少，修改时请聚焦主流程：

- `main.js`：自动模式主入口（通知触发 + 多备用定时 + 日志/结果通知）。
- `tools/manual-checkin.js`：手动执行一次签到，用于回归验证。
- `tools/analyze-screen.js`：页面控件分析工具，用于选择器排障。
- `project.json`：项目元信息（入口与版本号）。
- `README.md`：面向用户的使用文档。
- `CHANGELOG.md`：完整版本历史。
- `AutoJs6-Documentation/`：本地官方文档快照，**禁止修改**。

---

## 技术栈与运行环境

- 运行环境：AutoJs6（Rhino JS）。
- 目标设备：Android 7.0+（API 24+）。
- 语言要求：ES5（`var` / `function`），避免 ES6+ 特性。
- 配置模式：脚本内 `CONFIG` 自包含，不依赖外部配置文件。

---

## 运行与开发方式

本仓库没有 Node/Python 构建流程，主要在 AutoJs6 内运行：

- 自动模式：运行 `main.js`
- 手动模式：运行 `tools/manual-checkin.js`
- 页面分析：运行 `tools/analyze-screen.js`

可选打包命令（示例）：

- `git archive -o auto-workwx-v1.8.3.zip HEAD`

---

## 代码风格规范

- 4 空格缩进，保持流程代码简洁直白。
- 命名：变量/函数 `camelCase`，常量 `UPPER_SNAKE_CASE`。
- 选择器优先 `textContains`，避免过于严格的全量匹配。
- 使用“最小必要改动”：只改当前任务相关逻辑。
- 重构时删除旧实现，不保留冗余兼容分支。

---

## 核心实现约定（必须遵守）

- 触发机制：通知触发（时间窗 + 关键词）与备用定时并存。
- 备用定时：仅在时间点后的短窗口触发，且启动当天默认跳过已过时间点。
- 互斥执行：必须通过 `AtomicBoolean` 锁控制并发（禁止并行签到流程）。
- 保活策略：前台通知每 30 秒刷新，使用固定通知 ID 覆盖更新。
- 结果反馈：签到结束后发送系统通知并写入日志文件。
- 超时约束：全局 3 分钟超时，新增流程不得绕开。
- 活动处理：预扫描列表、按名称去重、逐个处理。
- 点击策略：控件点击失败时回退到父节点或坐标点击。

---

## 测试与验收清单

当前无自动化测试，合并前至少手测以下项：

- 通知触发是否命中（包名、时间窗、关键词过滤正常）
- 备用定时是否按时间点触发，且单时间点最多重试 3 次
- 并发保护是否生效（通知与备用同时触发时仅执行一次）
- 已签到活动是否跳过，错过签到是否正确标记
- 拍照链路（权限弹窗、快门、使用照片、填写原因）是否完整
- 日志文件是否正常写入 `logs/checkin-YYYY-MM-DD.log`

---

## 常见风险点

- `"为何不能签到？"` 是固定链接，不能作为过期判断依据。
- 远程运行模式下，`currentPackage/currentActivity` 可能不可用。
- 输入后若不 `back()` 收起键盘，可能遮挡“完成签到”按钮。
- WebView 容器容易被误判为可点击目标，需按 class/Y 坐标过滤。
- `fallbackTimes` 若全无效，备用定时会失效（需在启动日志确认告警）。

---

## 文档维护规范

代码行为变化后，必须同步更新：

- `README.md` 的功能表、配置说明、流程描述、FAQ、更新日志
- `CHANGELOG.md` 的版本历史明细
- `AGENTS.md` 的实现约束与测试清单
- `project.json` 的版本号（仅在发布版本时）

文档更新时应优先保证：

1. 配置项与代码字段完全一致
2. 流程说明与当前实现一致
3. 版本历史与实际提交一致

---

## Git 与提交规范

- 提交信息遵循 Conventional Commits（`feat:` / `fix:` / `docs:` / `refactor:`）。
- 一次提交聚焦一类变更，避免混改。
- 未经明确允许，不自动 `commit`/`push`。
- 允许提交时，先自检再提交（至少做语法检查和关键路径验证）。
- 提交信息都使用中文。

---

## 版本号规范（SemVer）

格式：`MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]`

- MAJOR：不兼容变更
- MINOR：向后兼容新增功能
- PATCH：向后兼容修复

预发布阶段：

- `alpha` → `beta` → `rc` → 正式版

禁止事项：

- 禁止跳版本、跨级别递增、手动跳阶段
- 禁止修改 `AutoJs6-Documentation/` 下任何文件
