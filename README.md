# 辅导猫自动签到脚本

基于 AutoJs6 的企业微信辅导猫自动签到工具。

---

## 当前版本

- 版本号：`1.8.3`
- 运行入口：`main.js`
- 手动单次签到工具：`tools/manual-checkin.js`
- 页面分析工具：`tools/analyze-screen.js`

---

## 功能总览

| 功能 | 说明 |
| --- | --- |
| 通知触发 | 监听企业微信通知，按包名 + 时间窗 + 关键词三重过滤后触发 |
| 多备用定时 | 支持多个备用时间点（如 `10:30`、`12:00`、`18:00`），仅在到点后 60 秒窗口内触发 |
| 备用重试控制 | 每个备用时间点最多重试 3 次，且 30 秒内不重复同一时间点 |
| 运行互斥锁 | 使用 `AtomicBoolean` 防止通知触发与备用定时并发执行 |
| 前台通知保活 | 每 30 秒刷新同一通知 ID，减少保活通知被手动移除后的失效 |
| 批量活动处理 | 预扫描当日活动并按名称去重，逐个进入详情处理 |
| 拍照签到链路 | 自动处理“去拍照 -> 权限弹窗 -> 快门 -> 使用照片 -> 填写原因 -> 完成签到” |
| 结果通知 | 签到结束后推送系统通知，后台运行时也能快速查看结果 |
| 日志持久化 | 追加写入 `logs/checkin-YYYY-MM-DD.log`，用于追溯 |
| 全局超时保护 | 整个签到流程 3 分钟超时，防止卡死 |
| 每日状态重置 | 日期变化后自动重置 `todayTriggered` 和备用状态 |

---

## 项目结构

```text
auto-workwx/
├── main.js                 # 自动模式：通知监听 + 多备用定时 + 日志/通知输出
├── project.json            # AutoJs6 项目配置（版本、主入口等）
├── README.md               # 使用文档
├── AGENTS.md               # 维护者规范
├── LICENSE
├── logs/                   # 运行后自动生成
└── tools/
    ├── manual-checkin.js   # 手动执行一次完整签到流程
    └── analyze-screen.js   # 当前界面控件分析与定位辅助
```

---

## 环境要求

| 项目 | 要求 |
| --- | --- |
| 系统 | Android 7.0+（API 24+） |
| 软件 | [AutoJs6](https://github.com/SuperMonster003/AutoJs6/releases/latest) |
| 账号 | 企业微信已登录且可进入辅导猫 |
| 权限 | 无障碍服务、通知访问、后台运行白名单 |
| 锁屏 | 建议无锁屏密码或启用 Smart Lock |

---

## 快速开始

### 1) 安装与导入

1. 安装 AutoJs6。
2. 下载本项目并解压到 AutoJs6 工作目录（如 `/sdcard/脚本/`）。
3. 在 AutoJs6 打开项目。

### 2) 必要权限

| 权限 | 必需 | 备注 |
| --- | --- | --- |
| 无障碍服务 | 是 | 选择器/点击能力基础 |
| 通知访问 | 是（自动模式） | 通知触发需要 |
| 后台运行与电池白名单 | 是 | 降低被系统回收概率 |
| 悬浮窗 | 否 | 仅辅助调试 |

### 3) 配置 `main.js`

```javascript
var CONFIG = {
    packageName: "com.tencent.wework",
    reasonText: "离校",
    entryText: "辅导猫",
    keywords: ["打卡", "签到", "辅导猫"],
    startHour: 7,
    startMinute: 50,
    endHour: 8,
    endMinute: 10,
    fallbackTimes: ["10:30", "12:00", "18:00"],
};
```

### 4) 运行

- 自动模式：运行 `main.js`
- 手动模式：运行 `tools/manual-checkin.js`
- 页面分析：运行 `tools/analyze-screen.js`

---

## 配置项详解

| 字段 | 默认值 | 说明 |
| --- | --- | --- |
| `packageName` | `com.tencent.wework` | 通知来源包名 |
| `reasonText` | `离校` | 范围外签到时填写内容 |
| `entryText` | `辅导猫` | 企业微信内入口文案 |
| `keywords` | `["打卡","签到","辅导猫"]` | 通知标题/正文命中任意词即匹配 |
| `startHour/startMinute` | `07:50` | 通知触发生效起点 |
| `endHour/endMinute` | `08:10` | 通知触发生效终点 |
| `fallbackTimes` | `["10:30","12:00","18:00"]` | 备用时间点数组（可多项） |

`fallbackTimes` 解析规则：

- 仅接受 `HH:mm` 格式（`0-23` 时，`0-59` 分）。
- 非法项会被忽略。
- 重复项自动去重。
- 解析后会按时间升序执行。

---

## 自动模式工作机制（`main.js`）

### 1) 触发入口

- 通知入口：`events.on("notification")`
  - 先过滤包名
  - 再过滤时间窗
  - 最后匹配关键词
- 备用入口：`setInterval(..., 30000)`
  - 每 30 秒检查是否到达某个备用时间点
  - 每个时间点仅在“到点后 60 秒内”触发
  - 脚本启动当天，仅处理“启动时刻之后”的备用时间点
  - 每个时间点独立重试计数，最多 3 次

### 2) 并发互斥

- `runningFlag.compareAndSet(false, true)` 抢占执行权
- 抢锁失败直接忽略本次触发
- `finally` 中释放锁，避免异常后锁泄漏

### 3) “今日完成”判定

以下任一满足会设置 `todayTriggered = true`：

- 本轮至少有一个活动签到成功
- 本轮无失败、无错过，且存在“已签到”活动
- 当日无活动（视为无需签到）

---

## 签到流程分解

1. 唤醒屏幕并上滑解锁
2. 重启并启动企业微信（最多 3 次）
3. 进入辅导猫并读取当日活动（页面重试最多 2 次）
4. 预扫描活动列表，解析截止时间，构建待处理队列
5. 逐个活动执行签到：
   - 识别“签到/范围外签到”按钮
   - 处理“继续签到”
   - 必要时定位底部签到按钮
   - 去拍照、权限弹窗、快门、使用照片
   - 填写原因、收起键盘、完成签到
6. 汇总结果并输出通知/日志

---

## 日志与结果通知

### 系统结果通知

- 标题：`辅导猫签到结果`
- 内容：摘要（成功/已签到/错过/失败）

### 持久化日志

- 路径：`logs/checkin-YYYY-MM-DD.log`
- 写入方式：追加写入（同日多次执行会累计）
- 记录内容：
  - 触发来源（通知触发/备用定时）
  - 开始与结束时间
  - 汇总结果
  - 每个活动的结果与截止时间（如有）

---

## 调试工具说明

### `tools/manual-checkin.js`

- 用于立即执行一次完整流程
- 适合在改选择器后快速验证
- 会弹窗展示最终结果

### `tools/analyze-screen.js`

- 输出当前界面中的：
  - TextView 文本控件
  - WebView 内文本元素
  - 可点击控件
  - 输入框、按钮、图片控件
  - 常见关键词命中结果
- 用于定位“为什么找不到按钮/为什么点错位置”

---

## 常见问题（精简版）

### 通知没触发

- 确认通知访问权限已开启
- 确认企业微信通知未被静音
- 确认当前时间在配置的通知时间窗内
- 确认通知正文包含关键词

### 备用定时没触发

- 确认脚本仍在后台运行
- 确认 `fallbackTimes` 有合法值
- 确认当天未被标记为完成
- 确认当前时刻仍在“时间点后的 60 秒窗口”内
- 若当天在较晚时间才启动脚本，已过的备用时间点会被自动跳过

### 找不到签到按钮

- 先运行 `tools/analyze-screen.js` 看当前文案和坐标
- 检查企业微信/辅导猫页面结构是否变化
- 检查是否出现“已结束”或“未签到但无按钮”的过期场景

### 拍照环节失败

- 确认相机权限弹窗已正确处理
- 检查快门按钮尺寸与位置是否仍满足识别条件
- 必要时用 `analyze-screen.js` 定位图片控件

---

## 注意事项

- `"为何不能签到？"` 是详情页固定文案，不能作为过期判断依据。
- 首次拍照场景必须覆盖权限弹窗（允许/始终允许/仅在使用中允许）。
- 新增逻辑不要绕过全局超时控制。
- AutoJs6 被系统杀后台时，备用定时和通知监听都会失效。

---

## 更新日志

### v1.8.3

- 调整备用定时触发策略：每个时间点仅在到点后 60 秒窗口内触发
- 调整启动策略：脚本启动当天自动跳过已过的备用时间点，避免“启动即补触发”
- 同步完善文档：更新触发机制、FAQ、维护规范与注释说明

### v1.8.2

- 修复自动模式潜在锁死：去除流程内阻塞弹窗，避免长时间占用执行锁
- 修复并发竞态：改为 `AtomicBoolean` 原子锁，通知触发与备用定时不会并发进入
- 修复当日完成判定：无活动/全已签到时也标记完成，避免重复执行
- 增强容错：通知监听启动失败时降级为仅备用定时
- 增加配置告警：`fallbackTimes` 全无效时启动即告警

### v1.8.1

- 修复日志目录创建与写入稳定性
- 统一脚本格式
- 同步文档与配置说明

### v1.8.0

- 新增多备用定时（`fallbackTimes`）
- 新增签到结果系统通知
- 新增签到日志持久化

> 更早版本历史请查看 `git log` 或仓库提交记录。

---

## License

MIT
