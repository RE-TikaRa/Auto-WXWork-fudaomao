# 辅导猫自动签到脚本

基于 AutoJs6 的企业微信辅导猫自动签到工具，支持多活动批量签到。目前仅支持企业微信首页消息列表有辅导猫的推送通知，并且建议置顶。

## 功能特性

| 功能 | 说明 |
|------|------|
| 通知触发 | 监听企业微信通知，匹配关键词自动执行签到 |
| 备用定时 | 错过通知时段后，在指定时间自动补签 |
| 前台服务 | 常驻通知防止系统杀死脚本，提高后台存活率 |
| 批量处理 | 自动遍历今日所有打卡活动，逐个处理 |
| 智能跳过 | 检测"已签到"状态，自动跳过已完成的活动 |
| 范围外签到 | 自动处理范围外弹窗、拍照、填写原因 |
| 权限弹窗 | 自动处理相机权限请求弹窗 |
| 超时保护 | 3 分钟全局超时，防止脚本卡死 |
| 日期重置 | 每日自动重置触发标记，无需手动干预 |
| 运行锁 | 防止签到流程重复执行 |
| 活动恢复 | 活动列表丢失时自动重新进入辅导猫 |

## 环境要求

| 要求 | 说明 |
|------|------|
| 系统 | Android 7.0+ (API 24) |
| 软件 | [AutoJs6](https://github.com/SuperMonster003/AutoJs6/releases/latest) |
| 账号 | 企业微信已登录并加入辅导猫 |
| 权限 | 无障碍服务、通知访问权限 |
| 锁屏 | 无锁屏密码或启用 Smart Lock |

## 测试环境

| 项目 | 信息 |
|------|------|
| 设备 | 一加 ACE 3 (OnePlus PJE110) |
| 系统 | ColorOS 16.0.2.400 |

## 项目结构

```
auto-workwx/
├── main.js                 # 自动签到服务（通知监听 + 备用定时）
├── project.json            # AutoJs6 项目配置
├── README.md
├── LICENSE
└── tools/
    ├── manual-checkin.js   # 手动签到（立即执行一次）
    └── analyze-screen.js   # 界面分析调试工具
```

## 快速开始

### 1. 安装 AutoJs6

1. 访问 [AutoJs6 发布页](https://github.com/SuperMonster003/AutoJs6/releases/latest)
2. 下载最新版本 APK 并安装
3. 打开 AutoJs6，按提示授予基本权限

### 2. 下载项目

1. 访问本项目 [Releases 页面](../../releases/latest)
2. 下载最新版本压缩包
3. 解压到 AutoJs6 工作目录：
   - 默认路径：`/sdcard/脚本/` 或 `/sdcard/Scripts/`
   - 若无可自行创建，然后在 AutoJs6 中修改目录
   - 可在 AutoJs6 设置中查看或修改工作目录

### 3. 授予权限

在手机设置中为 AutoJs6 开启以下权限：

| 权限 | 设置路径 | 必需 |
|------|----------|------|
| 无障碍服务 | 设置 - 无障碍 - 已下载的应用 - AutoJs6 | 是 |
| 通知访问 | 设置 - 应用 - 特殊应用权限 - 通知访问 - AutoJs6 | 是 |
| 后台运行 | 设置 - 电池 - AutoJs6 - 无限制 | 是 |
| 悬浮窗 | 设置 - 应用 - 特殊应用权限 - 显示在其他应用上层 | 可选 |

不同品牌手机设置路径可能略有不同，AutoJs6 内置了权限开关入口。

### 4. 修改配置

编辑 `main.js` 文件顶部的 `CONFIG` 对象：

```javascript
var CONFIG = {
    packageName: "com.tencent.wework",  // 企业微信包名（一般无需修改）
    reasonText: "离校",                  // 范围外签到时填写的原因
    entryText: "辅导猫",                 // 企业微信工作台中辅导猫入口文本
    keywords: ["打卡", "签到", "辅导猫"], // 通知触发关键词
    startHour: 7,                        // 通知触发时段开始（小时）
    startMinute: 50,                     // 通知触发时段开始（分钟）
    endHour: 8,                          // 通知触发时段结束（小时）
    endMinute: 10,                       // 通知触发时段结束（分钟）
    fallbackHour: 10,                    // 备用定时签到（小时）
    fallbackMinute: 30                   // 备用定时签到（分钟）
};
```

配置说明：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| reasonText | "离校" | 范围外签到时自动填写的原因 |
| entryText | "辅导猫" | 企业微信工作台中的入口名称 |
| keywords | ["打卡", "签到", "辅导猫"] | 通知标题或内容包含任一关键词即触发 |
| startHour:startMinute | 07:50 | 通知触发生效开始时间 |
| endHour:endMinute | 08:10 | 通知触发生效结束时间 |
| fallbackHour:fallbackMinute | 10:30 | 备用定时签到时间 |

手动签到的配置在 `tools/manual-checkin.js` 顶部，格式相同但只需配置前三项。

### 5. 运行脚本

**自动签到（推荐）**

1. 在 AutoJs6 中打开项目
2. 运行 `main.js`
3. 保持 AutoJs6 在后台运行

运行后会显示：
```
===== 辅导猫自动签到服务 =====
监听包名: com.tencent.wework
触发关键词: 打卡, 签到, 辅导猫
通知触发时段: 07:50 - 08:10
备用定时: 10:30 (如通知未触发)

监听中... (保持脚本运行)
```

**手动签到**

运行 `tools/manual-checkin.js`，立即执行一次签到流程。

## 工作原理

### 触发逻辑

```
┌──────────────────────────────────────────────────────────────┐
│                      main.js 运行中                           │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  [通知触发] 07:50 - 08:10                                     │
│  ├─ 收到企业微信通知                                          │
│  ├─ 检查是否在生效时段内                                      │
│  ├─ 检查是否匹配关键词                                        │
│  │   ├─ 匹配 → 执行签到 → 成功后标记今日已完成                │
│  │   └─ 不匹配 → 忽略                                        │
│                                                              │
│  [备用定时] 10:30                                             │
│  ├─ 检查今日是否已签到成功                                    │
│  │   ├─ 未签到 → 执行签到                                    │
│  │   └─ 已签到 → 跳过                                        │
│                                                              │
│  [日期重置] 00:00                                             │
│  └─ 重置每日签到标记和备用定时标记                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 签到流程

```
唤醒屏幕 → 上滑解锁 → 杀掉企业微信后台 → 启动企业微信
    ↓
进入辅导猫 → 查找今日活动
    ↓
┌─ 遍历每个活动 ─────────────────────────────────┐
│                                               │
│  检查签到状态                                  │
│  ├─ 已签到 → 跳过，处理下一个                  │
│  └─ 未签到 → 继续                             │
│       ↓                                       │
│  点击签到按钮（范围外签到/签到）                │
│       ↓                                       │
│  处理"继续签到"弹窗（如有）                    │
│       ↓                                       │
│  去拍照 → 处理权限弹窗 → 点击快门 → 使用照片   │
│       ↓                                       │
│  填写原因 → 收起键盘 → 完成签到                │
│       ↓                                       │
│  返回活动列表，处理下一个                       │
│                                               │
└───────────────────────────────────────────────┘
    ↓
输出签到结果汇总
```

### 技术细节

| 机制 | 说明 |
|------|------|
| 轮询等待 | 使用 200ms 间隔轮询检测元素，元素出现后等待 500ms 动画再操作 |
| 签到按钮识别 | 通过 Y 坐标过滤（300 < Y < 屏幕高度*0.7），排除底部导航栏 |
| 快门按钮识别 | 屏幕中央的 ImageView，宽度为屏幕宽度的 10%-20% |
| 活动遍历 | 使用 while 循环处理第一个元素，避免签到后列表变化导致索引错位 |
| 运行锁 | isRunning 标记防止通知重复触发时并发执行 |
| 备用定时防重 | fallbackTriggered 标记防止同一分钟内重复触发 |
| 成功标记 | todayTriggered 只在签到成功后设置，失败不影响备用定时 |

## 锁屏设置

脚本需要在屏幕解锁状态下运行。推荐以下方案：

**方案一：禁用锁屏（最简单）**

设置 - 安全 - 屏幕锁定 - 选择"无"

**方案二：Smart Lock 信任场所**

1. 设置 - 安全 - Smart Lock
2. 添加"信任的地点"（如宿舍、家）
3. 在信任地点时设备自动保持解锁

**方案三：Smart Lock 信任设备**

1. 设置 - 安全 - Smart Lock
2. 添加"信任的蓝牙设备"（如手环、耳机）
3. 连接信任设备时自动保持解锁

## 常见问题

**Q: 脚本运行后没有反应？**

A: 检查无障碍服务是否开启，部分手机需要重新开启才能生效。

**Q: 通知触发不工作？**

A: 检查以下几点：
- 通知访问权限是否授予
- 企业微信通知是否被静音或屏蔽
- 当前时间是否在通知触发时段内（默认 07:50-08:10）
- 通知内容是否包含配置的关键词

**Q: 备用定时不触发？**

A: 检查以下几点：
- 脚本是否在后台持续运行
- 通知触发时段内是否已成功签到（成功后不会触发备用定时）
- 备用定时时间是否已过

**Q: 脚本被系统杀掉？**

A: 关闭 AutoJs6 的电池优化，将其加入后台白名单。部分手机还需要：
- 锁定 AutoJs6 在最近任务列表
- 开启 AutoJs6 的自启动权限
- 关闭省电模式

**Q: 找不到签到按钮？**

A: 使用 `tools/analyze-screen.js` 分析当前界面，检查：
- 签到按钮的文本是否为"签到"或"范围外签到"
- 签到按钮的 Y 坐标是否在有效范围内

**Q: 拍照失败？**

A: 检查以下几点：
- 相机权限是否已授予
- 快门按钮是否被正确识别（可用 analyze-screen.js 检查）
- 拍照时建议遮挡摄像头（实现黑屏照片）

**Q: 如何修改配置？**

A: 直接编辑 `main.js` 顶部的 `CONFIG` 对象，保存后重新运行脚本。

**Q: 如何查看运行日志？**

A: 在 AutoJs6 中查看控制台输出，或在设置中开启日志文件保存。

## 注意事项

- 拍照时请遮挡摄像头（实现黑屏照片）
- 首次运行建议手动观察整个流程
- 脚本有 3 分钟全局超时保护
- 需要保持 AutoJs6 后台运行
- 建议关闭电池优化，防止被系统杀掉
- 签到成功后才会标记今日已完成，失败不影响备用定时

## 更新日志

### v1.6.0

- 合并"已过期"和"错过签到"为统一的 `missed` 状态
- 简化结果弹窗：成功/已签到/错过签到/失败

### v1.5.0

- 优化活动名称显示：分离活动名称和截止时间，不再截断
- 结果弹窗显示完整活动名和截止时间（格式：活动名 (截止:2/21 22:00)）

### v1.4.1

- 启动时自动关闭上次运行遗留的弹窗（仅限本脚本的 alert 弹窗），避免遮挡导致启动失败

### v1.4.0

- 新增"错过签到"状态：识别已过期但未签到的活动（显示"未签到"但无签到按钮）
- 结果弹窗区分"已过期"和"错过签到"两种状态

### v1.3.1

- 在更多失败场景添加 debugPage 调用：企业微信启动失败、未找到辅导猫入口、没有今日活动

### v1.3.0

- 签到失败时自动调用 debugPage 分析当前页面，输出关键词检测和可点击控件信息

### v1.2.0

- 已过期活动也会进入详情页检查是否已签到（不再直接跳过）
- 结果弹窗显示失败/过期的具体活动名称

### v1.1.1

- 修复错误的过期判断逻辑："为何不能签到？"是页面固定链接，不能作为过期依据
- 过期检测现在仅依赖"已结束"印章和截止时间解析

### v1.1.0

- 在活动列表页根据截止时间过滤已过期活动，避免进入详情页后才发现过期
- 解析活动文本中的截止时间（格式：签到截止时间：2026年02月21日 22:00）
- 预扫描时标记已过期活动

### v1.0.16

- 修复页面加载过程中误判为过期的问题（将过期检测移到 waitFor 超时后）
- 只在轮询中查找签到按钮，超时后再检查过期状态

### v1.0.15

- 修复页面加载过程中误判为过期的问题
- 调整检测优先级：签到按钮 > 已签到 > 已过期（先找按钮再判断状态）

### v1.0.14

- 重构活动遍历逻辑：预扫描生成待签到列表，按名称去重避免重复处理
- 移除 while 循环，改用 for 循环遍历预生成的列表
- 每次处理前重新查找活动元素，适应页面刷新

### v1.0.13

- 修复 WebView 容器被误识别为签到按钮的问题
- 优化底部签到按钮检测（80% < Y < 95%），排除底部导航栏（Y > 95%）

### v1.0.12

- 修复已结束活动误点击底部导航栏"签到"tab 的问题
- 添加"已结束"印章检测，自动跳过已过期活动
- 优化"范围外签到"按钮识别，排除底部导航栏区域

### v1.0.11

- 修复签到时间过期检测时机问题（改为点击签到按钮后检测）
- 添加详细调试日志功能（debugPage）

### v1.0.10

- 修复强行停止后启动不回首页问题（用 home() 替代 back()）
- 启动后自动点击底部"消息"tab 确保回到消息页
- 移除 manual-checkin.js 中重复的启动代码

### v1.0.9

- 添加无障碍服务检测（运行前验证服务可用）
- 添加辅导猫页面加载失败重试机制（最多 2 次）

### v1.0.8

- 检测签到时间过期的活动并自动跳过（使用"已结束"印章检测）
- 结果弹窗新增"已过期"计数

### v1.0.7

- 修复通知触发时 UI 线程阻塞问题（使用子线程执行签到）

### v1.0.6

- 签到完成后弹窗显示结果（成功/已签到/失败数量）
- 添加 toast 短提示

### v1.0.5

- 修复前台通知在部分环境下无法创建的问题
- 简化通知代码，提高兼容性

### v1.0.4

- 添加前台服务通知机制，防止系统杀死后台脚本
- 为所有脚本添加完整详细注释（签到流程、算法说明、配置文档）
- tools/manual-checkin.js：添加签到状态机、拍照流程、遍历策略等注释
- tools/analyze-screen.js：添加控件类型说明、WebView 元素分析、快门识别等注释

### v1.0.3

- 修复活动遍历索引错位问题（改用 while 循环）
- 修复备用定时重复触发问题（添加 fallbackTriggered 标记）
- 修复 todayTriggered 设置时机（只在成功后设置）
- 修复变量名遮蔽问题（text 改名 notificationText）
- 添加唤醒失败检查
- 添加相机权限弹窗自动处理
- 快门按钮使用相对尺寸识别（10%-20% 屏幕宽度）
- 添加 app 启动检测结果检查
- 添加 activity.text() 空值保护

### v1.0.2

- 初始版本
- 通知触发 + 备用定时
- 批量活动处理
- 范围外签到支持

## License

MIT
